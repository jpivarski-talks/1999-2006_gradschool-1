#!/usr/local/bin/perl

die if ( $#ARGV != 7 );

$do_y1stail = $ARGV[0];
$do_y2stail = $ARGV[1];
$do_beamgas = $ARGV[2];
$do_twophoton = $ARGV[3];
$do_mccutefficiency = $ARGV[4];
$do_taus = $ARGV[5];

$corrections = "";
if ( $do_y1stail == 1 ) { $corrections .= "y1stail "; }
if ( $do_y2stail == 1 ) { $corrections .= "y2stail "; }
if ( $do_beamgas == 1 ) { $corrections .= "beamgas "; }
if ( $do_twophoton == 1 ) { $corrections .= "twophoton "; }
if ( $do_mccutefficiency == 1 ) { $corrections .= "mccutefficiency "; }
if ( $do_taus == 1 ) { $corrections .= "taus "; }

%lumi = (
	 122536 => [1296.2, 10.3],
	 122537 => [1336.0, 10.4],
	 122538 => [1292.9, 10.2],
	 122539 => [1300.5, 10.3],
	 122540 => [1225.4, 10.0],
	 122541 => [1213.0, 9.9],
	 122542 => [1129.7, 9.6],
	 122545 => [1165.6, 9.7],
	 122546 => [163.5, 3.6],
	 122548 => [1126.5, 9.6],
	 122549 => [1383.6, 10.6],
	 122550 => [1301.9, 10.3],
	 122551 => [1314.1, 10.3],
	 122555 => [844.7, 8.3],
	 122556 => [870.3, 8.4],
	 122557 => [853.5, 8.3],
	 122559 => [1175.9, 9.8],
	 122560 => [1140.3, 9.6],
	 122562 => [1114.4, 9.5],
	 122563 => [1088.6, 9.4],
	 122564 => [1252.0, 10.1],
	 122567 => [60.6, 2.2],
	 122568 => [1057.3, 9.3],
	 122569 => [924.2, 8.7],
	 122570 => [1676.7, 11.7],
	 122571 => [1645.6, 11.5],
	 122572 => [1725.4, 11.8],
	 122573 => [1737.6, 11.9],
	 122574 => [1301.5, 10.3],
	 122575 => [1189.6, 9.8],
	 122576 => [362.5, 5.4],
	 122577 => [1314.9, 10.3],
	 122578 => [109.3, 3.0],
	 122579 => [442.6, 6.0],
	 122585 => [1675.7, 11.7],
	 122586 => [1670.6, 11.6],
	 122587 => [1660.5, 11.6],
	 122590 => [1415.6, 10.7],
	 122593 => [685.9, 7.5],
	 122594 => [755.9, 7.8],
	 122595 => [178.9, 3.8],
	 122596 => [1309.9, 10.3],
	 122599 => [419.7, 5.8],
	 122600 => [106.2, 2.9],
	 122602 => [1740.0, 11.9],
	 122603 => [1818.1, 12.1],
	 122604 => [1789.9, 12.0],
	 122605 => [1811.3, 12.1],
	 122606 => [558.7, 6.7],
	 122608 => [1769.9, 12.0],
	 122610 => [1923.4, 12.5],
	 122613 => [624.9, 7.1],
	 122614 => [2341.3, 13.8],
	 122615 => [2336.3, 13.8],
	 122616 => [2300.1, 13.7],
	 122618 => [2249.3, 13.5],
	 122619 => [2340.0, 13.8],
	 122620 => [2346.7, 13.8],
	 122622 => [203.2, 4.1],
	 122623 => [1012.8, 9.1],
	 122625 => [1662.3, 11.6],
	 122626 => [2178.6, 13.3],
	 122627 => [154.2, 3.5],
	 122628 => [525.8, 6.5],
	 122629 => [2253.8, 13.5],
	 122631 => [577.4, 6.8],
	 122632 => [658.6, 7.3],
	 122634 => [851.4, 8.3],
	 122640 => [1306.3, 10.3],
	 122641 => [2159.8, 13.2],
	 122642 => [2359.4, 13.8],
	 122643 => [2016.9, 12.8],
	 122646 => [1091.1, 9.4],
	 122647 => [891.5, 8.5],
	 122648 => [1190.9, 9.8],
	 122649 => [2331.6, 13.7],
	 122650 => [2163.6, 13.2],
	 122653 => [2387.3, 13.9],
	 122654 => [2075.0, 13.0],
	 122657 => [1260.3, 10.1],
	 122658 => [909.2, 8.6],
	 122661 => [740.9, 7.7],
	 122665 => [1663.6, 11.6],
	 122667 => [1180.8, 9.8],
	 122668 => [129.5, 3.2],
	 122669 => [176.5, 3.8],
	 122672 => [2250.7, 13.5],
	 122673 => [2303.8, 13.7],
	 );

%beamgas = (
	    122536 => 47.48559866661389,
	    122537 => 43.855259441268615,
	    122538 => 45.139510123361106,
	    122539 => 44.844067746649074,
	    122540 => 46.43513282479852,
	    122541 => 46.123980676732195,
	    122542 => 39.79748701399319,
	    122545 => 44.389482987625776,
	    122548 => 39.73438989630818,
	    122549 => 50.18023316583675,
	    122550 => 48.15093144410595,
	    122551 => 49.975733899149695,
	    122555 => 27.87130088000949,
	    122556 => 32.536504154826055,
	    122557 => 33.87768571713592,
	    122559 => 40.8778351618897,
	    122560 => 41.406269353656945,
	    122562 => 42.00107174182277,
	    122563 => 41.272728770468795,
	    122564 => 42.59322116559461,
	    122568 => 39.888157144907545,
	    122569 => 41.685147470302596,
	    122570 => 66.91846860918947,
	    122571 => 66.74683520195485,
	    122572 => 68.42847218520896,
	    122573 => 69.84688640445533,
	    122574 => 53.14483538781313,
	    122575 => 49.007610015933444,
	    122576 => 13.52917058545976,
	    122577 => 46.469202587164276,
	    122579 => 18.229345266058345,
	    122585 => 64.62496201053341,
	    122586 => 65.24594785531644,
	    122587 => 68.08921429544071,
	    122590 => 55.45774936973189,
	    122593 => 25.8668660635051,
	    122594 => 32.74297139898708,
	    122596 => 51.69599807036799,
	    122599 => 16.442325059393024,
	    122602 => 66.78665766310999,
	    122603 => 69.75275722094742,
	    122604 => 71.53355386801641,
	    122605 => 73.47864493497536,
	    122606 => 23.817876382324286,
	    122608 => 56.77707081033336,
	    122610 => 61.23191002474488,
	    122613 => 19.45752052591028,
	    122614 => 77.79764378935973,
	    122615 => 77.27492645459179,
	    122616 => 76.42690768170718,
	    122618 => 75.98193841463701,
	    122619 => 77.22729010390776,
	    122620 => 76.5467921710133,
	    122623 => 35.76768647905781,
	    122625 => 53.60598336772157,
	    122626 => 74.07471926652784,
	    122628 => 16.906868764989103,
	    122629 => 74.46034441709186,
	    122631 => 20.704200206738577,
	    122632 => 23.614458971185105,
	    122634 => 29.08675356712127,
	    122640 => 43.345341162730634,
	    122641 => 74.90900804586883,
	    122642 => 77.20244698034686,
	    122643 => 64.95907944001607,
	    122646 => 33.3128124243501,
	    122647 => 30.141338186665553,
	    122648 => 36.359118071140124,
	    122649 => 76.46704468590008,
	    122650 => 74.40486565788275,
	    122653 => 77.61627767273124,
	    122654 => 67.22027698044296,
	    122657 => 38.34019622158721,
	    122658 => 34.09729047898615,
	    122661 => 23.052186237440008,
	    122665 => 51.98556272016448,
	    122667 => 14.974823615495566,
	    122672 => 71.98335843461189,
	    122673 => 72.55256797432213,
	    );

open(IN, $ARGV[6]);
open(OUT, "> $ARGV[7]");
print "$ARGV[6] --> $ARGV[7] with $corrections:\n";

while(<IN>) {
    chop;
    (my $run, my $energy, my $events) = split(/\s+/);
    my $original_events = $events;
    
    if ( $do_y1stail == 1 ) {
	my $y1s_hxc = (18.9 / (2000.*$energy - 9460.3));
	my $y1s_events = $lumi{$run}->[0] * $y1s_hxc;
	$events -= $y1s_events;
    } # end apply y1stail

    if ( $do_y2stail == 1 ) {
	my $y2s_hxc = (7.9 / (2000.*$energy - 10024.6));
	my $y2s_events = $lumi{$run}->[0] * $y2s_hxc;
	$events -= $y2s_events;
    } # end apply y2stail

    if ( $do_beamgas == 1 ) {
	$events -= $beamgas{$run};
    } # end apply beamgas

    if ( $do_twophoton == 1 ) {
#       this was a mistake in the PTA talk
#	$events -= 0.19794 * log($energy * $energy); # this log is natural

#   Ritchie's suggestion
#  	$events -= 0.19794 * log($energy * 2000. * $energy * 2000.) / log(10330. * 10330.)
#  	    * $lumi{$run}->[0] / 11958.78 * $events;

	my $hadron_xc = $events / $lumi{$run}->[0];
	my $twophoton_xc = 1.011 * log($energy * 2000. * $energy * 2000.) / log(10330. * 10330.);
	my $twophoton_events = $events * $twophoton_xc / $hadron_xc;
	$events -= $twophoton_events;

    } # end apply twophoton

    if ( $do_mccutefficiency == 1 ) {
	my $energyMeV = $energy * 2000.;
	my $normalized_peak = `echo "20.338703 10.35820 4.668636 0 0.0263 $energyMeV" | ./spitout`;
	chop $normalized_peak;
	# This comes from the fact that continuum MC has 94.4% efficiency in the cuts
	# and resonance MC has 93.17%. We need to put in more correction at the peak
	# than at the continuum.
	my $correction_factor = (1./0.944 + ( (1./0.9317 - 1./0.944) * $normalized_peak ));
	$events *= $correction_factor;
    } # end apply mccutefficiency

    if ( $do_taus == 1 ) {
	my $energyMeV = $energy * 2000.;
	my $hadron_xc = `echo "77.05870 10.35820 4.668636 0 0.0263 $energyMeV" | ./spitout`;
	chop $hadron_xc;
	my $tau_xc = $hadron_xc * 0.0181 / (1. - 3. * 0.0181);
	my $num_before_cuts = $tau_xc * $lumi{$run}->[0];
	my $num_after_cuts = $num_before_cuts * 0.24689;
	$events -= $num_after_cuts;
    } # end apply taus

    print OUT "$run $energy $events\n";
    print "$run $energy has $original_events -> $events     (" .
	(100.*($original_events-$events)/$original_events) . "%)\n";
}
